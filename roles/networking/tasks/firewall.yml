---
#/ip firewall filter
#  .id looks to be being ignored.
# Router is injecting a rule 0, so .id is always 1 off
# Rule with hw=yes always returned changed, and a duplicate rule is added.
- name: Firewall settings
  community.routeros.api_modify:
    handle_absent_entries: remove
    handle_entries_content: remove_as_much_as_possible
    ensure_order: true
    path: ip firewall filter
    data: "{{ firewall_rules2 }}"

# Loops don't work with absent handler. Only the last item remains.
#      - action: "{{ item.action }}"
#        chain: "{{ item.chain }}"
#        comment: "{{ item.comment | default(omit) }}"
#        address-list: "{{ item.address_list | default(omit) }}"
#        address-list-timeout: "{{ item.address_list_timeout | default(omit) }}"
#        connection-bytes: "{{ item.connection_bytes | default(omit) }}"
#        connection-limit: "{{ item.connection_limit | default(omit) }}"
#        connection-mark: "{{ item.connection_mark | default(omit) }}"
#        connection-nat-state: "{{ item.connection_nat_state | default(omit) }}"
#        connection-rate: "{{ item.connection_rate | default(omit) }}"
#        connection-state: "{{ item.connection_state | default(omit) }}"
#        connection-type: "{{ item.connection_type | default(omit) }}"
#        content: "{{ item.content | default(omit) }}"
#        disabled: "{{ item.disabled | default(omit) }}"
#        dscp: "{{ item.dscp | default(omit) }}"
#        dst-address: "{{ item.dst_address | default(omit) }}"
#        dst-address-list: "{{ item.dst_address_list | default(omit) }}"
#        dst-address-type: "{{ item.dst_address_type | default(omit) }}"
#        dst-limit: "{{ item.dst_limit | default(omit) }}"
#        dst-port: "{{ item.dst_port | default(omit) }}"
#        fragment: "{{ item.fragment | default(omit) }}"
#        hotspot: "{{ item.hotspot | default(omit) }}"
#        hw-offload: "{{ item.hw_offload | default(omit) }}"
#        icmp-options: "{{ item.icmp_options | default(omit) }}"
#        in-bridge-port: "{{ item.in_bridge_port | default(omit) }}"
#        in-bridge-port-list: "{{ item.in_bridge_port_list | default(omit) }}"
#        in-interface: "{{ item.in_interface | default(omit) }}"
#        in-interface-list: "{{ item.in_interface_list | default(omit) }}"
#        ingress-priority: "{{ item.ingress_priority | default(omit) }}"
#        ipsec-policy: "{{ item.ipsec_policy | default(omit) }}"
#        ipv4-options: "{{ item.ipv4_options | default(omit) }}"
#        jump-target: "{{ item.jump_target | default(omit) }}"
#        layer7-protocol: "{{ item.layer7_protocol | default(omit) }}"
#        limit: "{{ item.limit | default(omit) }}"
#        log: "{{ item.log | default(omit) }}"
#        log-prefix: "{{ item.log_prefix | default(omit) }}"
#        nth: "{{ item.nth | default(omit) }}"
#        out-bridge-port: "{{ item.out_bridge_port | default(omit) }}"
#        out-bridge-port-list: "{{ item.out_bridge_port_list | default(omit) }}"
#        out-interface: "{{ item.out_interface | default(omit) }}"
#        out-interface-list: "{{ item.out_interface_list | default(omit) }}"
#        p2p: "{{ item.p2p | default(omit) }}"
#        packet-mark: "{{ item.packet_mark | default(omit) }}"
#        packet-size: "{{ item.packet_size | default(omit) }}"
#        per-connection-classifier: "{{ item.per_connection_classifier | default(omit) }}"
#        port: "{{ item.port | default(omit) }}"
#        priority: "{{ item.priority | default(omit) }}"
#        protocol: "{{ item.protocol | default(omit) }}"
#        psd: "{{ item.psd | default(omit) }}"
#        random: "{{ item.random | default(omit) }}"
#        realm: "{{ item.realm | default(omit) }}"
#        reject-with: "{{ item.reject_with | default(omit) }}"
#        routing-mark: "{{ item.routing_mark | default(omit) }}"
#        routing-table: "{{ item.routing_table | default(omit) }}"
#        src-address: "{{ item.src_address | default(omit) }}"
#        src-address-list: "{{ item.src_address_list | default(omit) }}"
#        src-address-type: "{{ item.src_address_type | default(omit) }}"
#        src-mac-address: "{{ item.src_mac_address | default(omit) }}"
#        src-port: "{{ item.src_port | default(omit) }}"
#        tcp-flags: "{{ item.tcp_flags | default(omit) }}"
#        tcp-mss: "{{ item.tcp_mss | default(omit) }}"
#        time: "{{ item.time | default(omit) }}"
#        tls-host: "{{ item.tls_host | default(omit) }}"
#        ttl: "{{ item.ttl | default(omit) }}"
#         # .id: "*{{ rindex + 1 }}"
#  loop: "{{ firewall_rules }}"
#  loop_control:
#    index_var: rindex
#
